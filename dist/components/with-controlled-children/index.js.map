{"version":3,"file":"index.js","sources":["../../../components/with-controlled-children/index.js"],"sourcesContent":["import { compose as wpCompose, data } from 'wp';\nimport classnames from 'classnames/dedupe';\n\nconst { compose } = wpCompose;\nconst { withDispatch, withSelect } = data;\n\nconst INACTIVE_CHILD_CLASS = 'ghwp-inactive-child';\n\n/**\n * A higher order component that allows fine-grained control over dependent children\n *\n * @param component\n * @return {*}\n * @constructor\n */\nexport const WithControlledChildren = (component) =>\n    compose([\n        withSelect((select, ownProps) => {\n            const blockEditorSelect = select('core/block-editor');\n            const { getBlock } = blockEditorSelect;\n            const { clientId } = ownProps;\n\n            const innerBlocks = getBlock(clientId).innerBlocks;\n\n            return {\n                children: innerBlocks,\n            };\n        }),\n        withDispatch((dispatch, ownProps, { select }) => {\n            const {\n                insertBlock,\n                moveBlockToPosition,\n                removeBlock,\n                removeBlocks,\n                selectBlock,\n                updateBlockAttributes,\n            } = dispatch('core/block-editor');\n            // prettier-ignore\n            const {\n                getBlock,\n                getBlockIndex,\n                getAdjacentBlockClientId,\n            } = select('core/block-editor');\n\n            const {\n                attributes: { currentlyEditedChildIndex },\n                clientId,\n                setAttributes,\n            } = ownProps;\n\n            const block = getBlock(clientId);\n\n            const getCurrentlyEditedChildClientId = () => {\n                const index =\n                    currentlyEditedChildIndex !== null &&\n                    typeof currentlyEditedChildIndex !== 'undefined'\n                        ? currentlyEditedChildIndex\n                        : 0;\n                return block.innerBlocks[index]\n                    ? block.innerBlocks[currentlyEditedChildIndex].clientId\n                    : null;\n            };\n\n            const setCurrentlyEditedChildIndex = ({\n                clientId: childClientId,\n            }) => {\n                const childIndex = childClientId\n                    ? getBlockIndex(childClientId, clientId)\n                    : 0;\n                block.innerBlocks.forEach((child, index) => {\n                    let isVisible = false;\n                    if (index === childIndex) isVisible = true;\n                    const className = child.attributes.className;\n                    updateBlockAttributes(child.clientId, {\n                        isVisible,\n                        className: classnames(className, {\n                            [INACTIVE_CHILD_CLASS]: !isVisible,\n                        }),\n                    });\n                });\n                setAttributes({\n                    currentlyEditedChildIndex: childIndex,\n                });\n            };\n\n            const selectNextChild = () => {\n                if (\n                    currentlyEditedChildIndex ===\n                    block.innerBlocks.length - 1\n                ) {\n                    return false;\n                }\n\n                const newBlockClientId = getAdjacentBlockClientId(\n                    getCurrentlyEditedChildClientId(),\n                    1\n                );\n                setCurrentlyEditedChildIndex({ clientId: newBlockClientId });\n                return true;\n            };\n\n            const selectPreviousChild = () => {\n                if (currentlyEditedChildIndex === 0) return false;\n                const newBlockClientId = getAdjacentBlockClientId(\n                    getCurrentlyEditedChildClientId(),\n                    -1\n                );\n                setCurrentlyEditedChildIndex({ clientId: newBlockClientId });\n                return true;\n            };\n\n            const updateChildrenRecord = () => {\n                setAttributes({\n                    children: getBlock(clientId).innerBlocks,\n                });\n            };\n\n            return {\n                insertChild(newBlock) {\n                    insertBlock(\n                        newBlock,\n                        parseInt(block.innerBlocks.length, 10),\n                        clientId,\n                        false // do not update the selection and \"steal focus\"\n                    );\n                    updateChildrenRecord();\n                    setCurrentlyEditedChildIndex(newBlock);\n                    selectBlock(newBlock.clientId);\n                },\n                deleteChild(child) {\n                    if (!selectPreviousChild()) {\n                        selectNextChild();\n                    }\n                    removeBlock(child.clientId, true);\n                    updateChildrenRecord();\n                },\n                moveChild(child, direction = 'up') {\n                    const childId = child.clientId;\n                    const currentPosition =\n                        childId && getBlockIndex(childId, clientId);\n                    const isFirstGoingUp =\n                        currentPosition === 0 && direction === 'up';\n                    const isLastGoingDown =\n                        currentPosition + 1 === block.innerBlocks.length &&\n                        direction === 'down';\n                    const isPositionInvalid =\n                        currentPosition < 0 ||\n                        currentPosition === null ||\n                        typeof currentPosition === 'undefined';\n\n                    if (\n                        !childId ||\n                        isPositionInvalid ||\n                        isFirstGoingUp ||\n                        isLastGoingDown\n                    )\n                        return;\n                    const newIndex =\n                        direction === 'up'\n                            ? currentPosition - 1\n                            : currentPosition + 1;\n                    moveBlockToPosition(childId, clientId, clientId, newIndex);\n                    updateChildrenRecord();\n                },\n                /* expose a way to edit a child's attributes */\n                updateBlockAttributes,\n                removeBlocks,\n                setCurrentlyEditedChild: setCurrentlyEditedChildIndex,\n                selectNextChild,\n                selectPreviousChild,\n                /* Utility function for when data from children needs to used\n                 * to render parts of the parent component (in the save function)\n                 * â†’ see tabsBlock > TabHeader\n                 *\n                 * Needs to be called separately after each dispatch call that\n                 * involves modifying the nested tab components; calling\n                 * setAttributes from inside the individual dispatch functions does\n                 * not seem to work reliably\n                 */\n                updateChildrenRecord,\n            };\n        }),\n    ])(component);\n"],"names":["compose","wpCompose","withDispatch","data","withSelect","INACTIVE_CHILD_CLASS","WithControlledChildren","component","select","ownProps","blockEditorSelect","getBlock","clientId","innerBlocks","children","dispatch","insertBlock","moveBlockToPosition","removeBlock","removeBlocks","selectBlock","updateBlockAttributes","getBlockIndex","getAdjacentBlockClientId","currentlyEditedChildIndex","attributes","setAttributes","block","getCurrentlyEditedChildClientId","index","setCurrentlyEditedChildIndex","childClientId","childIndex","forEach","child","isVisible","className","classnames","selectNextChild","length","newBlockClientId","selectPreviousChild","updateChildrenRecord","insertChild","newBlock","parseInt","deleteChild","moveChild","direction","childId","currentPosition","isFirstGoingUp","isLastGoingDown","isPositionInvalid","newIndex","setCurrentlyEditedChild"],"mappings":"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"}